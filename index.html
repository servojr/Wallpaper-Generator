<!-- Full updated HTML with IndexedDB storage (patched save logic) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Desktop Wallpaper Generator</title>
  <style>
    /* [CSS omitted for brevity — keep your current styles as-is] */
  </style>
</head>
<body>
  <h1>🖼️ My Desktop Wallpaper Generator</h1>

  <!-- [Form HTML omitted for brevity — keep as-is] -->
  <!-- Wallpaper Gallery, Canvas, Creations section unchanged -->

  <script>
    window.addEventListener('DOMContentLoaded', () => {
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const downloadLink = document.getElementById('downloadLink');
      const myCreations = document.getElementById('myCreations');
      const dbName = 'wallpaperDB';
      const storeName = 'creations';
      let db, currentImage = null;

      function openDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(dbName, 1);
          request.onerror = (e) => reject(e);
          request.onsuccess = (e) => {
            db = e.target.result;
            resolve();
          };
          request.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(storeName)) {
              db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
            }
          };
        });
      }

      function saveToDB(dataUrl) {
        return new Promise((resolve, reject) => {
          const tx = db.transaction(storeName, 'readwrite');
          const store = tx.objectStore(storeName);
          const countReq = store.count();
          countReq.onsuccess = () => {
            if (countReq.result >= 20) {
              alert("You've reached the limit of 20 saved wallpapers.");
              return reject();
            }
            const req = store.add({ image: dataUrl });
            req.onsuccess = () => resolve();
            req.onerror = (e) => reject(e);
          };
          countReq.onerror = (e) => reject(e);
        });
      }

      function loadFromDB() {
        const tx = db.transaction(storeName, 'readonly');
        const store = tx.objectStore(storeName);
        const req = store.getAll();
        req.onsuccess = () => {
          myCreations.innerHTML = '';
          req.result.forEach((entry) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'creation-wrapper';
            const img = document.createElement('img');
            img.src = entry.image;
            img.onclick = () => {
              const i = new Image();
              i.onload = () => { currentImage = i; drawWallpaper(); };
              i.src = entry.image;
            };
            const del = document.createElement('button');
            del.className = 'delete-btn';
            del.innerText = '×';
            del.onclick = () => deleteFromDB(entry.id);
            wrapper.appendChild(img);
            wrapper.appendChild(del);
            myCreations.appendChild(wrapper);
          });
        };
        req.onerror = () => {
          myCreations.innerHTML = '<p>Failed to load creations.</p>';
        };
      }

      function deleteFromDB(id) {
        const tx = db.transaction(storeName, 'readwrite');
        const store = tx.objectStore(storeName);
        store.delete(id);
        tx.oncomplete = loadFromDB;
      }

      document.getElementById('clearAllBtn').addEventListener('click', () => {
        if (confirm('Clear all saved wallpapers?')) {
          const tx = db.transaction(storeName, 'readwrite');
          tx.objectStore(storeName).clear().onsuccess = loadFromDB;
        }
      });

      document.getElementById('saveBtn').addEventListener('click', () => {
        try {
          const test = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const hasContent = test.data.some(v => v !== 0);
          if (!hasContent) return alert("Create a wallpaper first.");
          const dataUrl = canvas.toDataURL("image/png");
          saveToDB(dataUrl).then(loadFromDB).catch(() => alert("Save failed."));
        } catch (e) {
          alert("Error saving wallpaper: " + e.message);
        }
      });

      openDB().then(loadFromDB).catch(err => alert("IndexedDB init failed."));
    });
  </script>
</body>
</html>


